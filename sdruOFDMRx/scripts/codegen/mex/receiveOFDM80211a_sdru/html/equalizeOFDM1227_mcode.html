<pre class="code">
<span class="srcline"><span class="lineno"><a href="139,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T25U3">R</span>, <span class="var type1" id="S3T740U4">Rraw</span>, <span class="var type1" id="S4T23U5">estimate</span>] = equalizeOFDM( <span class="var type1" id="S5T516U8">recv</span>, <span class="mxinfo" id="T1:U5"><span class="var type1" id="S6T1U9">tx</span></span>, <span class="mxinfo" id="T23:U7"><span class="mxinfo" id="T23:U8"><span class="var type1" id="S4T23U10">estimate</span></span></span>, <span class="var type1" id="S7T556U11">hPreambleDemod</span>, <span class="var type1" id="S8T605U12">hDataDemod</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="139,2" id="srcline2"> 2</a></span><span class="line">    <span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,3" id="srcline3"> 3</a></span><span class="line">    <span class="comment">% equalizeOFDM: Equalize the entire OFDM frame through the use of both</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,4" id="srcline4"> 4</a></span><span class="line">    <span class="comment">% the long preamble from the 802.11a standard and four pilot tones in</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,5" id="srcline5"> 5</a></span><span class="line">    <span class="comment">% the data frames themselves.  The gains from the pilots are</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,6" id="srcline6"> 6</a></span><span class="line">    <span class="comment">% interpolated across frequency to fill the data frame and apply gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,7" id="srcline7"> 7</a></span><span class="line">    <span class="comment">% to all data subcarriers.</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,8" id="srcline8"> 8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="139,9" id="srcline9"> 9</a></span><span class="line">    <span class="comment">%% Use Long Preamble frame to estimate channel in frequency domain</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,10" id="srcline10">10</a></span><span class="line">    <span class="comment">% Separate out received preambles</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,11" id="srcline11">11</a></span><span class="line">    <span class="mxinfo" id="T6:U12"><span class="var type1" id="S9T6U15">rLong</span> = <span class="mxinfo" id="T6:U14"><span class="var type1" id="S5T516U17">recv</span>(<span class="mxinfo" id="T815:U16"><span class="mxinfo" id="T2:U17">length(<span class="var type1" id="S6T1U23">tx</span>.completeShortPreambleOFDM)+1</span> : <span class="mxinfo" id="T2:U19">length(<span class="var type1" id="S6T1U30">tx</span>.completeShortPreambleOFDM)+length(<span class="var type1" id="S6T1U35">tx</span>.completeLongPreambleOFDM)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,12" id="srcline12">12</a></span><span class="line">    <span class="mxinfo" id="T5:U22"><span class="var type1" id="S11T5U39">rLongFirst</span> = <span class="mxinfo" id="T5:U24"><span class="var type1" id="S9T6U41">rLong</span>(<span class="mxinfo" id="T806:U26"><span class="mxinfo" id="T2:U27">33</span>:<span class="mxinfo" id="T2:U28">32+length(<span class="var type1" id="S6T1U49">tx</span>.longPreambleOFDM)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,13" id="srcline13">13</a></span><span class="line">    <span class="mxinfo" id="T5:U30"><span class="var type1" id="S12T5U53">rLongSecond</span> = <span class="mxinfo" id="T5:U32"><span class="var type1" id="S9T6U55">rLong</span>(<span class="mxinfo" id="T806:U34"><span class="mxinfo" id="T2:U35">33+length(<span class="var type1" id="S6T1U62">tx</span>.longPreambleOFDM)</span> : <span class="mxinfo" id="T2:U37">32+length(<span class="var type1" id="S6T1U70">tx</span>.longPreambleOFDM)*2</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,14" id="srcline14">14</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="139,15" id="srcline15">15</a></span><span class="line">    <span class="comment">% Demod</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,16" id="srcline16">16</a></span><span class="line">    <span class="mxinfo" id="T759:U39"><span class="var type1" id="S13T759U75">RLongFirst</span> = <span class="mxinfo" id="T759:U41">step(<span class="var type1" id="S7T556U78">hPreambleDemod</span>, <span class="var type1" id="S11T5U79">rLongFirst</span>)</span></span>; <span class="comment">%First half of long preamble</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,17" id="srcline17">17</a></span><span class="line">    <span class="mxinfo" id="T759:U44"><span class="var type1" id="S15T759U82">RLongSecond</span> = <span class="mxinfo" id="T759:U46">step(<span class="var type1" id="S7T556U85">hPreambleDemod</span>, <span class="var type1" id="S12T5U86">rLongSecond</span>)</span></span>; <span class="comment">%Second half of long preamble</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,18" id="srcline18">18</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="139,19" id="srcline19">19</a></span><span class="line">    <span class="comment">%% Preamble Equalization</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,20" id="srcline20">20</a></span><span class="line">    <span class="comment">% Get Equalizer tap gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,21" id="srcline21">21</a></span><span class="line">    <span class="mxinfo" id="T4:U49"><span class="var type1" id="S16T4U89">preambleEqGains</span> = <span class="mxinfo" id="T4:U51"><span class="fcn" id="F939N57:B91">preambleFDE</span>(<span class="mxinfo" id="T764:U52">[<span class="var type1" id="S13T759U94">RLongFirst</span>, <span class="var type1" id="S15T759U95">RLongSecond</span>]</span>, <span class="mxinfo" id="T564:U55">[<span class="var type1" id="S6T1U99">tx</span>.longPreamble, <span class="var type1" id="S6T1U102">tx</span>.longPreamble]</span>, <span class="var type1" id="S6T1U104">tx</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,22" id="srcline22">22</a></span><span class="line">      </span></span>
<span class="srcline"><span class="lineno"><a href="139,23" id="srcline23">23</a></span><span class="line">    <span class="comment">% Separate data from preambles</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,24" id="srcline24">24</a></span><span class="line">    <span class="mxinfo" id="T566:U59"><span class="var type1" id="S18T566U107">recvData</span> = <span class="mxinfo" id="T566:U61"><span class="var type1" id="S5T516U109">recv</span>(<span class="mxinfo" id="T809:U63"><span class="mxinfo" id="T2:U64">length(<span class="var type1" id="S6T1U115">tx</span>.preambles)+1</span>:<span class="mxinfo" id="T2:U66">length(<span class="var type1" id="S6T1U122">tx</span>.preambles)+(<span class="var type1" id="S6T1U128">tx</span>.hDataDemod.NumSymbols)*(<span class="var type1" id="S6T1U134">tx</span>.FFTLength+<span class="var type1" id="S6T1U138">tx</span>.hDataDemod.CyclicPrefixLength)</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,25" id="srcline25">25</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="139,26" id="srcline26">26</a></span><span class="line">    <span class="comment">% OFDM Demod</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,27" id="srcline27">27</a></span><span class="line">    <span class="mxinfo" id="T562:U71">[<span class="var type1" id="S3T740U144">Rraw</span>, <span class="var type1" id="S19T609U145">RXPilots</span>] = step(<span class="var type1" id="S8T605U148">hDataDemod</span>, <span class="var type1" id="S18T566U149">recvData</span>)</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,28" id="srcline28">28</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="139,29" id="srcline29">29</a></span><span class="line">    <span class="comment">% Expand equalizer gains to full frame size</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,30" id="srcline30">30</a></span><span class="line">    <span class="mxinfo" id="T610:U76"><span class="var type1" id="S20T610U152">preambleGainsFull</span> = <span class="mxinfo" id="T610:U78">repmat(<span class="var type1" id="S16T4U155">preambleEqGains</span> ,1 , <span class="var type1" id="S6T1U159">tx</span>.hDataDemod.NumSymbols)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,31" id="srcline31">31</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="139,32" id="srcline32">32</a></span><span class="line">    <span class="comment">% Isolate pilot gains from preamble equalizer</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,33" id="srcline33">33</a></span><span class="line">    <span class="mxinfo" id="T609:U81"><span class="var type1" id="S22T609U164">preamblePilotGains</span> = <span class="mxinfo" id="T609:U83"><span class="var type1" id="S20T610U166">preambleGainsFull</span>(<span class="mxinfo" id="T13:U85"><span class="var type1" id="S6T1U168">tx</span>.pilotLocationsWithoutGuardbands</span>,:)</span></span>; <span class="comment">% Needed to correctly adjust pilot gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,34" id="srcline34">34</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="139,35" id="srcline35">35</a></span><span class="line">    <span class="comment">% Apply preamble equalizer gains to data and pilots</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,36" id="srcline36">36</a></span><span class="line">    <span class="mxinfo" id="T609:U87"><span class="var type1" id="S19T609U173">RXPilots</span> = <span class="mxinfo" id="T609:U89"><span class="var type1" id="S22T609U175">preamblePilotGains</span>.*<span class="var type1" id="S19T609U176">RXPilots</span></span></span>; <span class="comment">%Correct pilots</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,37" id="srcline37">37</a></span><span class="line">    <span class="mxinfo" id="T729:U92"><span class="var type1" id="S2T729U179">R</span> = <span class="mxinfo" id="T729:U94"><span class="mxinfo" id="T25:U95"><span class="var type1" id="S20T610U182">preambleGainsFull</span>(<span class="mxinfo" id="T14:U97"><span class="var type1" id="S6T1U184">tx</span>.dataSubcarrierIndexies</span>,:)</span>.*<span class="var type1" id="S3T740U187">Rraw</span></span></span>;<span class="comment">%Correct data</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,38" id="srcline38">38</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="139,39" id="srcline39">39</a></span><span class="line">    <span class="comment">%% Pilot Equalization</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,40" id="srcline40">40</a></span><span class="line">    <span class="comment">% Get pilot-based equalizer gains</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,41" id="srcline41">41</a></span><span class="line">    <span class="mxinfo" id="T25:U100"><span class="var type1" id="S23T25U190">pilotEqGains</span> = <span class="mxinfo" id="T25:U102"><span class="fcn" id="F1226N56:B192">pilotFDE</span>(<span class="var type1" id="S19T609U193">RXPilots</span>, <span class="var type1" id="S6T1U195">tx</span>.pilots, 12)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,42" id="srcline42">42</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="139,43" id="srcline43">43</a></span><span class="line">    <span class="comment">% Apply Equalizer from Pilots</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,44" id="srcline44">44</a></span><span class="line">    <span class="mxinfo" id="T25:U105"><span class="var type1" id="S2T25U200">R</span> = <span class="mxinfo" id="T25:U107"><span class="var type1" id="S23T25U202">pilotEqGains</span>.*<span class="var type1" id="S2T729U203">R</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,45" id="srcline45">45</a></span><span class="line">       </span></span>
<span class="srcline"><span class="lineno"><a href="139,46" id="srcline46">46</a></span><span class="line">    <span class="comment">% Save Gains for visualization</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,47" id="srcline47">47</a></span><span class="line">    <span class="mxinfo" id="T25:U110"><span class="mxinfo" id="T25:U111"><span class="var type1" id="S4T23U207">estimate</span>.pilotEqGains</span> = <span class="var type1" id="S23T25U209">pilotEqGains</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,48" id="srcline48">48</a></span><span class="line">    <span class="mxinfo" id="T4:U114"><span class="mxinfo" id="T4:U115"><span class="var type1" id="S4T23U213">estimate</span>.preambleEqGains</span> = <span class="var type1" id="S16T4U215">preambleEqGains</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="139,49" id="srcline49">49</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="139,50" id="srcline50">50</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="139,51" id="srcline51">51</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="139,52" id="srcline52">52</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="139,53" id="srcline53">53</a></span><span class="line"><span class="comment">% Calculate Equalizer Taps with preamble symbols</span></span></span>
</pre>
